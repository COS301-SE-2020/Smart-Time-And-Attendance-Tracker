<html>
  <body onload="checkAuth()">
    <div id='content'>
      <h1>Events</h1>
      <h3 id="error"></h3>
      <ul id='events'></ul>
    </div>
    <a href='#' id='authorize-button' onclick='handleAuthClick();'>Login</a>
    <script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://apis.google.com/js/client.js"></script>
    <script>
        
      function checkAuth() {
        const http = new XMLHttpRequest();
        var apiURL = "http://localhost:3000/api/googleCalendar/getCredentials";
        http.open("POST",apiURL , true);
        http.setRequestHeader('Content-type', 'application/json');
        http.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            gapi.client.setApiKey(response.apiKey);
            gapi.auth.authorize({client_id: response.clientId, scope: response.scopes, immediate: true}, handleAuthResult);
          }
          else if(this.readyState == 4)
            document.getElementById('error').innerHTML = response.message;
        }
        http.send();
      }

      function handleAuthResult(authResult) {
        var authorizeButton = document.getElementById('authorize-button');
        if (authResult && !authResult.error) { 
          authorizeButton.style.visibility = 'hidden';
          makeApiCall(authResult);
        } else {
          authorizeButton.style.visibility = '';
          authorizeButton.onclick = handleAuthClick;
        }
      }

      function handleAuthClick(event) {
        const http = new XMLHttpRequest();
        var apiURL = "http://localhost:3000/api/googleCalendar/getCredentials";
        http.open("POST",apiURL , true);
        http.setRequestHeader('Content-type', 'application/json');
        http.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            gapi.auth.authorize({client_id: response.clientId, scope: response.scopes, immediate: false}, handleAuthResult); 
          }
          else if(this.readyState == 4)
            document.getElementById('error').innerHTML = response.message;    
        }
        http.send();
        return false;
      }
      
      function makeApiCall(authResult) {
        const http = new XMLHttpRequest();
        var apiURL = "http://localhost:3000/api/googleCalendar/getEvents?" 
                    + "accessToken=" + authResult.access_token 
                    + "&expiryDate=" + authResult.expires_at 
                    + "&tokenType=" + authResult.token_type ;

        http.open("GET",apiURL , true);
        http.setRequestHeader('Content-type', 'application/json');
        http.onreadystatechange = function() {
          if(this.readyState == 4 && this.status == 200) {
            var response = JSON.parse(this.responseText);
            if(response.Events)
            {
              var i=0;
              for (i in response.Events) {
                var li = document.createElement('li');
                li.appendChild(document.createTextNode(response.Events[i].Event));
                li.appendChild(document.createTextNode(" FROM " +  moment(response.Events[i].StartTime).format("L") + ' ' + moment(response.Events[i].StartTime).format("LT") ));
                li.appendChild(document.createTextNode(" TO " + moment(response.Events[i].EndTime).format("LT")  ));
              
                document.getElementById('events').appendChild(li);
              }
            }
            else
              document.getElementById('error').innerHTML = response.message;
          }
          else if(this.readyState == 4)
            document.getElementById('error').innerHTML = response.message;
        }
        http.send();  
      }
      
    </script>
  </body>
</html>